<?xml version="1.0" encoding="UTF-8"?>
<!-- Template: templates/configuration.xml.j2 -->
<configuration>
    <!-- Basic OpenGrok Configuration -->
    <sourceRoot>{{ opengrok_data }}/src</sourceRoot>
    <dataRoot>{{ opengrok_data }}/data</dataRoot>
    <projectsEnabled>true</projectsEnabled>
    <historyEnabled>true</historyEnabled>
    <remoteScmSupported>true</remoteScmSupported>
    <optimizeDatabase>true</optimizeDatabase>
    <generateHtml>true</generateHtml>
    
    <!-- Authentication Configuration -->
    <authenticationEnabled>true</authenticationEnabled>
    <authorizationEnabled>true</authorizationEnabled>
    
    <!-- OIDC Plugin Configuration -->
    <pluginDirectory>{{ opengrok_data }}/etc</pluginDirectory>
    <plugins>
        <plugin>
            <class>org.opengrok.indexer.authorization.plugins.OidcPlugin</class>
            <name>oidc</name>
            <configuration>
                <property>
                    <name>client_id</name>
                    <value>{{ keycloak_client_id }}</value>
                </property>
                <property>
                    <name>client_secret</name>
                    <value>{{ keycloak_client_secret }}</value>
                </property>
                <property>
                    <name>discovery_url</name>
                    <value>{{ keycloak_url }}/realms/{{ keycloak_realm }}/.well-known/openid_configuration</value>
                </property>
                <property>
                    <name>redirect_uri</name>
                    <value>{{ opengrok_url }}/api/v1/auth/callback</value>
                </property>
                <property>
                    <name>post_logout_redirect_uri</name>
                    <value>{{ opengrok_url }}</value>
                </property>
                <property>
                    <name>scope</name>
                    <value>openid profile email groups</value>
                </property>
                <property>
                    <name>username_claim</name>
                    <value>preferred_username</value>
                </property>
                <property>
                    <name>groups_claim</name>
                    <value>groups</value>
                </property>
                <property>
                    <name>email_claim</name>
                    <value>email</value>
                </property>
            </configuration>
        </plugin>
    </plugins>
    
    <!-- Web Application Settings -->
    <webappLAF>default</webappLAF>
    <remoteScmSupported>true</remoteScmSupported>
    <allowLeadingWildcard>true</allowLeadingWildcard>
    <indexVersionedFilesOnly>false</indexVersionedFilesOnly>
    
    <!-- Repository configurations can be added here -->
    <repositories>
        <!-- Add your source repositories here -->
    </repositories>
    
    <!-- Group definitions for authorization -->
    <authorizationGroups>
        <group>
            <name>default</name>
            <pattern>.*</pattern>
        </group>
        <group>
            <name>admins</name>
            <pattern>.*</pattern>
        </group>
    </authorizationGroups>
</configuration>
